## 2.1 OIS参考模型

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/1111111111111.png" alt="1111111111111" width = " 1500" />

> OSI 模型(Open Systems Interconnection Model)，由国际化标准组织ISO (The International Organization for Standardization ) 收录在ISO 7489标准中并于1984年发布。

- OIS参考模型中定义了每一层的“作用”
- 定义了每一层“作用”的是“协议”
- “协议”是约定，其具体内容是“规范”
- 我们日常所使用的就是遵循哥哥协议的具体“规范”的产品和通讯手段
- OSI未被广泛认可原因：层次太多麻烦复杂、功能重复

- 分层：模块化、标准化、流程化设计理念
- 带来的好处：减少复杂性、加速技术之间的兼容性、易于学习

- 每一个层次都是独立的（如：工作在物理层的网卡的收发速率的改变，上层不需要变化）
- 但每一层都紧密相连（如：工作在物理层的网卡出现故障，会导致上层都会收到影响 ）

### 2.1.1 各层的作用

1. **物理层：**
   - 在媒介上传输比特流；
   - 提供机械的和电气的规约；
   - 规定了电平、速度和电缆针脚等物理特性。
2. **数据链路层**：
   - 将分组数据封装成帧；
   - 在数据链路上实现数据的点到点、或点到多点方式的直接通信；
   - 差错检测；
   - 将比特组合成字节，再将字节组合成帧，使用链路层地址（以太网使用MAC地址）来访问介质，并进行差错检测。
3. **网络层**：
   - 定义逻辑（IP）地址；实现数据从源到目的地的转发（路由）；
   - 定义逻辑地址，供路由器确定路径，负责将数据从源网络传输到目的网络。

4. **应用层**：
   - 对应用程序提供接口；
   - 定义了应用层协议（HTTP、SNMP等）；
   - OSI参考模型中最靠近用户的一层，为应用程序提供网络服务。
5. **表示层：**
   - 进行数据格式的转换，以确保一个系统生成的应用层数据能够被另外一个系统的应用层所识别和理解；
   - 定义数据的格式；
   - 提供各种用于应用层数据的编码和转换功能，确保一个系统的应用层发送的数据能被另一个系统的应用层识别。
6. **会话层：**
   - 在通信双方之间建立、管理和终止会话；
   - 负责建立、管理和终止表示层实体之间的通信会话；
   - 该层的通信由不同设备中的应用程序之间的服务请求和响应组成。
7. **传输层：**
   - 建立、维护和取消一次端到端的数据传输过程；
   - 控制传输节奏的快慢，调整数据的排序等等；
   - 提供面向连接或非面向连接的数据传递以及进行重传前的差错检测。

## 2.2 TCP/IP分层模型

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/1111111111111.png" alt="1111111111111" width = " 1500" />

- TCP/IP模型将网络分为四层。
- TCP/IP模型不关注底层物理介质，主要关注终端之间的逻辑数据流转发。
- TCP/IP模型的核心是网络层和传输层，网络层解决网络之间的逻辑转发问题，传输层保证源端到目的端之间的可靠传输。
- 最上层的应用层通过各种协议向终端用户提供业务应用。

### 2.2.1 各层的作用

1. 应用层
   - 应用层为应用软件提供接口，使应用程序能够使用网络服务。
   - 应用层协议会指定使用相应的传输层协议，以及传输层所使用的端口等。
   -  应用层的PDU(Protocol Data Unit)被称为Data（数据）。
2. 传输层
   - 传输层协议接收来自应用层协议的数据
   - 封装上相应的传输层头部，帮助其建立“端到端”（Port to Port）的连接。
   - 建立主机之间进程与进程之间的连接 
   - 传输层的PDU被称为Segment（段）。
3. 网络层
   - 负责数据从一台主机到另外一台主机之间的传递。 
   - 网络层也叫Internet层 负责将分组报文从源主机发送到目的主机。 
   - 为网络中的设备提供逻辑地址。 
   - 负责数据包的寻径和转发。
   - 网络层的PDU被称为Packet（包）。
4. 数据链路层
   - 可以向网络层的IP、IPv6等协议提供服务。 
   - 以太网（Ethernet）是最常见的数据链路层协议。 
   - 数据链路层向网络层提供“段内通信”。
   - 负责组帧、物理编址、差错控制等功能。
   - 数据链路层的PDU被称为Frame（帧）。
5. 物理层
   - 数据到达物理层之后，物理层会根据物理介质的不同，将数字信号转换成光信号、电信号或者是电磁波信号。
   - 负责比特流在**介质**上的传输。 
   - 物理层的PDU被称为比特流（Bitstream）。  

## 2.3 应用层

应用层为应用软件提供接口，直接为应用程序提供网络服务。应用层协议会指定使用相应的传输层协议，以及传输层所使用的端口等。

应用层的 PDU 被称为Data（数据）。

### 2.3.1 DNS协议

- Domain Name System，域名解析系统
- 建立IP地址与域名之间的映射关系
- 将域名解析为IP地址
- 将IP地址解析为域名

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-16-40-46.png" alt="参考网路模型2022-03-14-16-40-46" width="500" height="">

### 2.3.2 HTTP协议

- Hypertext Transfer Protocol，超文本传输协议
- 帮助客户端访问万维网（World Wide Web）
- 网页浏览器通过翻译HTML（超文本标识语言）文件来表现文本、图像、音乐、动画及视频等对象

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-16-44-45.png" alt="参考网路模型2022-03-14-16-44-45" width="" height="">

### 2.3.4 SMTP与POP3：邮件服务

- SMTP：Simple Mail Transfer Protocol，简单邮件传输协议，用于发送邮件
- POP3：Post Office Protocol v3，邮局协议版本3，用于接收邮件
- IMAP：Internet Message Access Protocol），互联网邮件访问协议，类似POP3，功能更多

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-16-46-41.png" alt="参考网路模型2022-03-14-16-46-41" width="500" height="">

### 2.3.5 Telnet

- Terminal Network，终端网络
- 远程管理的主要协议（网络设备、服务器、数据库等）
- 常用终端工具有：SecureCRT、Putty、Xshell

### 2.3.6 FTP和TFTP

FTP：File Transfer Protocol，文件传输协议
- 提供可靠的文件传输服务
- 具有认证、权限等功能
TFTP：Trivial File Transfer Protocol，简单文件传输协议
- 提供不可靠的文件传输服务
- 常用于网络设备的配置文件和系统文件传输

## 2.4 传输层

传输层协议接收来自应用层协议的数据，封装上相应的传输层头部，帮助其建立“端到端”（Port to Port）的连接。

传输层的PDU被称为Segment（段）。

### 2.4.1 传输层端口

应用层的协议都是通过传输层端口来传输数据的。

常见协议的端口号：FTP 21、20，HTTP 80，Telnet 23，SMTP 25。

端口号范围 | 端口类别
--- | ---
0~1023 | 公认端口（知名端口）
1024~49151 | 注册端口
49152~65535 | 私有或动态端口

### 2.4.2 传输层协议

<iframe src="//player.bilibili.com/player.html?aid=418245176&bvid=BV1kV411j7hA&cid=343076847&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="750" height="500"> </iframe>

TCP：Transmission Control Protocol，传输控制协议
- 可靠的、面向连接的协议
- 传输效率低，类似打电话

UDP：User Datagram Protocol，用户数据报协议
- 不可靠的、无连接的服务
- 传输效率高，类似对讲机

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-17-05-38.png" alt="参考网路模型2022-03-14-17-05-38" width="" height="500">

### 2.4.3 TCP与UDP报文格式

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-17-08-01.png" alt="参考网路模型2022-03-14-17-08-01" width="500" height="">

#### 3.4.3.1 TCP报文头部字段解释

```shell
Transmission Control Protocol, Src Port: 7788, Dst Port: 2000, Seq: 0, Len: 0
    Source Port: 7788  #源端口，标识哪个应用程序发送。长度为16比特。
    Destination Port: 2000  #目的端口，标识哪个应用程序接收。长度为16比特。
    [Stream index: 27]
    [Conversation completeness: Complete, WITH_DATA (47)]
    [TCP Segment Len: 0]
    Sequence Number: 0    (relative sequence number)   #序号字段。TCP链接中传输的数据流每个字节都编上一个序号。序号字段的值指的是本报文段所发送数据的第一个字节的序号。长度为32比特。
    Sequence Number (raw): 4144767726
    [Next Sequence Number: 1    (relative sequence number)]
    Acknowledgment Number: 0  #确认序列号，是期望收到对方下一个报文段数据的第1个字节的序号，即上次已成功接收到的数据段的最后一个字节数据的序号加1。只有Ack标识为1，此字段有效。长度为32比特。
    Acknowledgment number (raw): 0
    1000 .... = Header Length: 32 bytes (8)  #头部长度，指出TCP报文头部长度，以32比特（4字节）为计算单位。若无选项内容，则该字段为5，即头部为20字节。
    Flags: 0x002 (SYN)  #控制位，包含FIN、ACK、SYN等标志位，代表不同状态下的TCP数据段。
        000. .... .... = Reserved: Not set  #保留，必须填0。长度为6比特。
        ...0 .... .... = Nonce: Not set
        .... 0... .... = Congestion Window Reduced (CWR): Not set
        .... .0.. .... = ECN-Echo: Not set
        .... ..0. .... = Urgent: Not set
        .... ...0 .... = Acknowledgment: Not set
        .... .... 0... = Push: Not set
        .... .... .0.. = Reset: Not set
        .... .... ..1. = Syn: Set
        .... .... ...0 = Fin: Not set
        [TCP Flags: ··········S·]
    Window: 64240  #窗口TCP的流量控制，这个值表明当前接收端可接受的最大的数据总数（以字节为单位）。窗口最大为65535字节。长度为16比特。
    [Calculated window size: 64240]
    Checksum: 0x149e [unverified]  #校验字段，是一个强制性的字段，由发端计算和存储，并由收端进行验证。在计算检验和时，要包括TCP头部和TCP数据，同时在TCP报文段的前面加上12字节的伪头部。长度为16比特。
    [Checksum Status: Unverified]
    Urgent Pointer: 0  #紧急指针，只有当URG标志置1时紧急指针才有效。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式。紧急指针指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）。长度为16比特。
    Options: (12 bytes), Maximum segment size, No-Operation (NOP), Window scale, No-Operation (NOP), No-Operation (NOP), SACK permitted  #选项字段（可选），长度为0-40字节。
    [Timestamps]  #时间戳
```

#### 2.4.3.2 UDP报文头部字段解释

```shell
User Datagram Protocol, Src Port: 123, Dst Port: 123
    Source Port: 123  #源端口，标识哪个应用程序发送。长度为16比特。
    Destination Port: 123  #目的端口，标识哪个应用程序接收。长度为16比特。
    Length: 56  #该字段指定UDP报头和数据总共占用的长度。可能的最小长度是8字节，因为UDP报头已经占用了8字节。由于这个字段的存在，UDP报文总长不可能超过65535字节（包括8字节的报头，和65527字节的数据）。
    Checksum: 0x913f [unverified]  #覆盖UDP头部和UDP数据的校验和，长度为16比特。
    [Checksum Status: Unverified]
    [Stream index: 16]
    [Timestamps]  #时间戳
    UDP payload (48 bytes)
```

### 2.4.4 TCP协议

#### 2.4.4.1 TCP的建立-三次握手

?> 任何基于TCP的应用，在发送数据之前，都需要由TCP进行“三次握手”建立连接。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-17-12-26.png" alt="参考网路模型2022-03-14-17-12-26" width="" height="">

- 由TCP连接发起方（图中PC1），发送第一个SYN位置1的TCP报文。初始序列号a为一个随机生成的数字，因为没收到过来自PC2的任何报文，所以确认序列号为0 ；
- 接收方（图中PC2）接收到合法的SYN报文之后，回复一个SYN和ACK置1的TCP报文。初始序列号b为一个随机生成的数字，同时因为此报文是回复给PC1的报文，所以确认序列号为a+1；
- PC1接收到PC2发送的SYN和ACK置位的TCP报文后，回复一个ACK置位的报文，此时序列号为a+1,确认序列号为b+1。PC2收到之后，TCP双向连接建立。

> **置位**
> 
> 在TCP报文的Flag标志位下包含了多个标志（如下图），置位与置位1的意思是在Flag中将该标志置为1，即设置此标志。
> 
> <img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-21-07-02.png" alt="参考网路模型2022-03-14-21-07-02" width="400" height="">

#### 2.4.4.2 TCP的序列号与确认序列号

?> TCP使用序列号和确认序列号字段实现**数据的可靠和有序传输**。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-21-14-16.png" alt="参考网路模型2022-03-14-21-14-16" width="" height="">

假设PC1要给PC2发送一段数据，传输过程如下：
1. PC1将全部待TCP发送的数据按照字节为单位编上号。假设第一个字节的编号为“a+1”，第二个字节的序号为“a+2”，依次类推。
2. PC1会把每一段数据的第一个字节的编号作为序列号（Sequence number），然后将TCP报文发送出去。
3. PC2在收到PC1发送来的TCP报文后，需要给予确认同时请求下一段数据，如何确定下一段数据呢？序列号( a+1 )+载荷长度=下一段数据的第一个字节的序号（a+1+12）
4. PC1在收到PC2发送的TCP报文之后，发现确认序列号为“a+1+12”，说明“a+1”到“a+12”这一段的数据已经被接受，下一段数据需要从“a+1+12”开始发送。

> 序列号+载荷长度=下一段数据的第一个字节的序号；
> 
> 如果在等待时间未收到ACK确认，会重新发送上一个包；
> 
> TCP可以一次对多个包进行确认

#### 2.4.4.3 TCP的窗口滑动机制

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-21-35-48.png" alt="参考网路模型2022-03-14-21-35-48" width="" height="">

TCP通过滑动窗口机制来控制数据的传输速率。
1. 在TCP三次握手建立连接时，双方都会通过Window字段告诉对方本端最大能够接受的字节数（也就是缓冲区大小）。
2. 连接建立成功之后，发送方会根据接受方宣告的Window大小发送相应字节数的数据。
3. 接受方接受到数据之后会放在缓冲区内，等待上层应用来取走缓冲的数据。若数据被上层取走，则相应的缓冲空间将被释放。
4. 接收方根据自身的缓存空间大小通告当前的可以接受的数据大小(Window)
5. 发送方根据接收方当前的Window大小发送相应数量的数据。

> 每次发送的数据包不一定等于window的大小，window只代表最大接受值。
> 
> window是根据缓冲区的空间大小实时协商的。

#### 2.4.4.4 TCP的关闭—四次挥手

当数据传输完成，TCP需要通过“四次挥手”机制断开TCP连接，释放系统资源。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-22-21-43.png" alt="参考网路模型2022-03-14-22-21-43" width="" height="">

TCP支持全双工模式传输数据，这意味着同一时刻两个方向都可以进行数据的传输。在传输数据之前，TCP通过三次握手建立的实际上是两个方向的连接，因此在传输完毕后，两个方向的连接必须都关闭。如图所示：
1. 由PC1发出一个FIN字段置”1 ”的不带数据的TCP段；
2. PC2收到PC1发来的FIN置位的TCP报文后，会回复一个ACK置位的TCP报文。
3. 若PC2也没有需要发送的数据，则直接发送FIN置位的TCP报文。假设此时PC2还有数据要发送，那么当PC2发送完这些数据之后会发送一个FIN置位的TCP报文去关闭连接。
4. PC1收到FIN置位的TCP报文，回复ACK报文，TCP双向连接断开。

#### 2.4.4.5 TCP连接状态总结

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-22-40-22.png" alt="参考网路模型2022-03-14-22-40-22" width="" height="">

- CLOSED：初始状态，表示TCP连接是”关闭着的”或”未打开的”
- LISTEN：表示服务器端的某个服务在特定端口处于监听状态，可以接受客户端的连接
- SYN_RCVD：表示服务器接收到了来自客户端请求连接的SYN报文。这个状态是在服务端的，但是它是一个中间状态，很短暂，平常我们用netstat或ss的时候，不太容易看到这种状态，但是遇到SYN flood之类的SYN攻击时，会出现大量的这种状态，即收不到三次握手最后一个客户端发来的ACK，所以一直是这个状态，不会转换到ESTABLISHED
- SYN_SENT：这个状态与SYN_RCVD状态相呼应，，它是TCP连接客户端的状态，当客户端发起连接时，首先发送SYN报文，然后随机进入到SYN_SENT状态，并等待服务端的SYN和ACK，该状态表示客户端的SYN已发送
- ESTABLISHED：表示TCP连接已经成功建立，开始传输数据
- FIN\_WAIT\_1：这个状态在实际工作中很少能看到，当客户端想要主动关闭连接时，它会向服务端发送FIN报文，此时TCP状态就进入到FIN\_WAIT\_1的状态，而当服务端回复ACK，确认关闭后，则客户端进入到FIN\_WAIT\_2的状态，也就是只有在没有收到服务端ACK的情况下，FIN\_WAIT\_1状态才能看到，然后长时间收不到ACK，通常会在默认超时时间60s(由内核参数tcp\_fin\_timeout控制)后，直接进入CLOSED状态
- FIN\_WAIT\_2：这个状态相比较常见，也是需要注意的一个状态，FIN\_WAIT\_1在接收到服务端ACK之后就进入到FIN\_WAIT\_2的状态，然后等待服务端发送FIN，所以在收到对端FIN之前，TCP都会处于FIN\_WAIT\_2的状态，也就是，在主动断开的一端发现大量的FIN\_WAIT\_2状态时，需要注意，可能时网络不稳定或程序中忘记调用连接关闭，FIN\_WAIT\_2也有超时时间，也是由内核参数tcp\_fin\_timeout控制，当FIN\_WAIT\_2状态超时后，连接直接销毁
- CLOSE\_WAIT：表示正在等待关闭，该状态只在被动端出现，即当主动断开的一端发送FIN报文给被动端，被动段必然会回应一个ACK，这个时候，TCP连接状态就进入到CLOSE\_WAIT
- LAST\_ACK：当被动关闭的一方在发送FIN报文后，等待对方的ACK报文的时候，就处于LAST\_ACK的状态，当收到对方的ACK之后，就进入到CLOSED状态了
- TIME\_WAIT：该状态是最常见的状态，主动方在收到对方FIN报文后，就由FIN\_WAIT\_2状态进入到TIME\_WAIT状态
- CLOSING：这个状态是一个比较特殊的状态，也比较少见，正常情况下不会出现，但是当双方同时都作为主动的一方关闭连接的时候，两边都进入FIN\_WAIT\_1 的状态，此时期望收到的是ACK包，进入 FIN\_WAIT\_2 的状态，但是却先收到了对方的FIN包，这个时候，就会进入到 CLOSING 的状态，然后给对方一个ACK，接收到 ACK 后直接进入到CLOSED状态。

### 2.4.5 UDP

- 不提供重传机制，占用资源小，处理效率高。
- 一些时延敏感的流量，如语音、视频等、通常使用UDP作为传输层协议

## 2.5 网络层

- 传输层负责建立主机之间进程与进程之间的连接，而网络层则负责数据从一台主机到另外一台主机之间的传递。
- 网络层的PDU被称为Packet（包）。
- 网络层也叫Internet层
- 负责将分组报文从源主机发送到目的主机。
- 网络层作用：
  - 为网络中的设备提供逻辑地址。
  - 负责数据包的寻径和转发。
- 常见协议如IPv4，IPv6、ICMP，IGMP等。
- IPv4( Internet Protocol Version 4)，简称IP，是目前应用最广泛的网络层协议。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网路模型2022-03-14-22-43-38.png" alt="参考网路模型2022-03-14-22-43-38" width="" height="">

当采用IP作为网络层协议时，通信的双方都会被分配到一个“独一无二”的IP地址来标识自己。IP地址可被写成32位的二进制整数值形式，但为了方便人们阅读和分析，它通常被写成点分十进制的形式，即四个字节被分开用十进制表示，中间用点分隔，比如192.168.1.1。

IP协议工作时，需要如OSPF、IS-IS、BGP等各种路由协议帮助路由器建立路由表，ICMP帮忙进行网络的控制和状态诊断

!> 关于IP协议详情请参考[3 网络层协议及IP编址](md/网络层协议及IP编址.md)

### 2.5.1 ICMP

Internet Control Message Protocol，Internet控制消息协议是IP协议的辅助协议。用来在网络设备间传递各种差错和控制信息。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-15-15-13-06.png" alt="参考网络模型2022-03-15-15-13-06" width="" height="150">

#### 2.5.1.1 ICMP报文

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-15-15-12-54.png" alt="参考网络模型2022-03-15-15-12-54" width="" height="100">

```shell
Internet Control Message Protocol
    Type: 8 (Echo (ping) request)  #消息类型
    Code: 0  #包含该消息类型的具体参数
    Checksum: 0x4cdc [correct]  #校验和字段用于检查消息是否完整
    [Checksum Status: Good]
    Identifier (BE): 1 (0x0001)
    Identifier (LE): 256 (0x0100)
    Sequence Number (BE): 127 (0x007f)
    Sequence Number (LE): 32512 (0x7f00)
    [Response frame: 128]
    Data (32 bytes)
```

类型Type | 代码Code | 描述 
:---: | :---: | :---
0 | 0 | 回显应答（ping应答） 
3 | 0 | 网络不可达  
3 | 1 | 主机不可达 
3 | 2 | 协议不可达 
3 | 3 | 端口不可达 
3 | 4 | 需要进行分片但设置不分片比特 
3 | 5 | 源站选路失败 
3 | 6 | 目的网络不认识 
3 | 7 | 目的主机不认识 
3 | 8 | 源主机被隔离（作废不用） 
3 | 9 | 目的网络被强制禁止 
3 | 10 | 目的主机被强制禁止 
3 | 11 | 由于TOS，网络不可达 
3 | 12 | 由于TOS，主机不可达 
3 | 13 | 由于过滤，通信被强制禁止 
3 | 14 | 主机越权 
3 | 15 | 优先权中止生效 
4 | 0 | 源端被关闭 
5 | 0 | 对网络重定向 
5 | 1 | 对主机重定向 
5 | 2 | 对服务类型和网络重定向 
5 | 3 | 对服务类型和主机重定向 
8 | 0 | 请求回显（ping请求） 
9 | 0 | 路由器通告 
10 | 0 | 路由器请求告 
11 | 0 | 传输期间生存时间为0 
11 | 1 | 在数据报组装期间生存时间为0 
12 | 0 | 坏的IP首部 
12 | 1 | 缺少必须的选项 
13 | 0 | 时间戳请求（作废不用） 
14 | 0 | 时间戳应答（作废不用） 
15 | 0 | 信息请求（作废不用） 
16 | 0 | 信息应答（作废不用） 
17 | 0 | 地址掩码请求 
18 | 0 | 地址掩码应答 


#### 2.5.1.2 ICMP重定向

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-15-14-50-40.png" alt="参考网络模型2022-03-15-14-50-40" width="400" height="">

1. 主机A希望发送报文到服务器A，于是根据配置的默认网关地址向网关RTB发送报文。
2. 网关RTB收到报文后，检查报文信息，发现报文应该转发到与源主机在同一网段的另一个网关设备RTA，此转发路径是更优的路径，所以RTB会向主机发送一个Redirect消息，通知主机直接向另一个网关RTA发送该报文。
3. 主机收到Redirect消息后，会向RTA发送报文，然后RTA会将该报文再转发给服务器A。

#### 2.5.1.3 ICMP差错检测

ICMP Echo消息常用于诊断源和目的地之间的网络连通性，同时还可以提供其他信息，如报文往返时间等。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-15-14-52-40.png" alt="参考网络模型2022-03-15-14-52-40" width="" height="150">

- Ping是网络设备、Windows、Unix和Linux平台上的一个命令，其实是一个小巧而实用的应用程序，该应用基于ICMP协议。
- Ping常用于探测到达目的节点的网络可达性。
- 用户可以在Ping命令中指定不同参数，如ICMP报文长度、发送的ICMP报文个数、等待回复响应的超时时间等，设备根据配置的参数来构造并发送ICMP报文，进行Ping测试。

```shell
-t             Ping 指定的主机，直到停止。若要查看统计信息并继续操作，请键入 Ctrl+Break；若要停止，请键入 Ctrl+C。
-a             将地址解析为主机名。
-n count       要发送的回显请求数。
-l size        发送缓冲区大小。
-f             在数据包中设置“不分段”标记(仅适用于IPv4)。
-i TTL         生存时间。
-v TOS         服务类型(仅适用于IPv4。该设置已被弃用，对IP标头中的服务类型字段没有任何影响)。
-r count       记录计数跃点的路由(仅适用于IPv4)。
-s count       计数跃点的时间戳(仅适用于IPv4)。
-j host-list   与主机列表一起使用的松散源路由(仅适用于IPv4)。
-k host-list    与主机列表一起使用的严格源路由(仅适用于IPv4)。
-w timeout     等待每次回复的超时时间(毫秒)。
-R             同样使用路由标头测试反向路由(仅适用于IPv6)。根据RFC 5095，已弃用此路由标头。如果使用此标头，某些系统可能丢弃回显请求。
-S srcaddr     要使用的源地址。
-c compartment 路由隔离舱标识符。
-p             Ping Hyper-V 网络虚拟化提供程序地址。
-4             强制使用IPv4。
-6             强制使用IPv6。
```

 Break按键 

#### 2.5.1.4 ICMP错误报告

ICMP定义了各种错误消息，用于诊断网络连接性问题；根据这些错误消息，源设备可以判断出数据传输失败的原因。
如果网络中发生了环路，导致报文在网络中循环，且最终TTL超时，这种情况下网络设备会发送TTL超时消息给发送端设备。

如果目的地不可达，则中间的网络设备会发送目的不可达消息给发送端设备。目的不可达的情况有多种，如果是网络设备无法找到目的网络，则发送目的网络不可达消息；如果网络设备无法找到目的网络中的目的主机，则发送目的主机不可达消息。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-15-15-14-05.png" alt="参考网络模型2022-03-15-15-14-05" width="" height="150">

- Tracert基于报文头中的TTL值来逐跳跟踪报文的转发路径。
- 为了跟踪到达某特定目的地址的路径，源端首先将报文的TTL值设置为1。
- 该报文到达第一个节点后，TTL超时，于是该节点向源端发送TTL超时消息，消息中携带时间戳。
- 然后源端将报文的TTL值设置为2，报文到达第二个节点后超时，该节点同样返回TTL超时消息，以此类推，直到报文到达目的地。
- 这样，源端根据返回的报文中的信息可以跟踪到报文经过的每一个节点，并根据时间戳信息计算往返时间。

```shell
-d                 不将地址解析成主机名。
-h maximum_hops    搜索目标的最大跃点数。
-j host-list       与主机列表一起的松散源路由(仅适用于 IPv4)。
-w timeout         等待每个回复的超时时间(以毫秒为单位)。
-R                 跟踪往返行程路径(仅适用于 IPv6)。
-S srcaddr         要使用的源地址(仅适用于 IPv6)。
-4                 强制使用 IPv4。
-6                 强制使用 IPv6。
```

## 2.6 数据链路层

- 数据链路层位于网络层和物理层之间，可以向网络层的IP、IPv6等协议提供服务。数据链路层的PDU被称为Frame（帧）。
- 常见的数据链路层协议有：以太网、PPPoE、PPP等，以太网（Ethernet）是最常见的数据链路层协议。
- 数据链路层位于网络层和物理层之间：
  - 数据链路层向网络层提供“段内通信”。
  - 负责组帧、物理编址、差错控制等功能。

### 2.6.1 以太网

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-07-08.png" alt="参考网络模型2022-03-14-23-07-08" width="300" height="">

- 以太网是一种广播式数据链路层协议，支持多点接入。
- 个人电脑的网络接口遵循的就是以太网标准。
- 一般情况下，一个广播域对应着一个IP网段。

### 2.6.2 以太网MAC地址

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-07-48.png" alt="参考网络模型2022-03-14-23-07-48" width="400" height="">

- MAC (Media Access Control)地址在网络中唯一标识一个网卡，每个网卡都需要且会有唯一的一个MAC地址。
- MAC用于在一个IP网段内，寻址找到具体的物理设备。
- 工作在数据链路层的设备。例如以太网交换机，会维护一张MAC地址表，用于指导数据帧转发。

### 2.6.3 ARP地址解析协议

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-10-22.png" alt="参考网络模型2022-03-14-23-10-22" width="" height="150">

地址解析协议(Address Resolution Protocol)，根据已知的IP地址解析获得其对应的MAC地址

- 根据IP地址获取数据链路层地址的一个TCP/IP协议。
- ARP是IPv4中必不可少的一种协议，它的主要功能是：
  - 将IP地址解析为MAC地址；
  - 维护IP地址与MAC地址的映射关系的缓存，即ARP表项；
  - 实现网段内重复IP地址的检测。

#### 2.6.3.1 ARP的工作原理

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-12-30.png" alt="参考网络模型2022-03-14-23-12-30" width="" height="">

- 网络设备一般都有一个ARP缓存（ARP Cache）。ARP缓存用来存放**IP地址和MAC地址的关联信息**。
- 在发送数据前，设备会先查找ARP缓存表。如果缓存表中存在对方设备的ARP表项，则直接采用该表项中的MAC地址来封装帧，然后将帧发送出去。如果缓存表中不存在相应信息，则通过发送ARP Request报文来获得它。
- 学习到的IP地址和MAC地址的映射关系会被放入ARP缓存表中存放一段时间。在有效期内（缺省：180s），设备可以直接从这个表中查找目的MAC地址来进行数据封装，而无需进行ARP查询。过了这段有效期，ARP表项会被自动删除。
- 如果目标设备位于其他网络，则源设备会在ARP缓存表中查找网关的MAC地址。然后将数据发送给网关。最后网关再把数据转发给目的设备。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-13-37.png" alt="参考网络模型2022-03-14-23-13-37" width="" height="">

- 主机1的ARP缓存表中不存在主机2的MAC地址，所以主机1会发送ARP Request来获取目的MAC地址。
- ARP Request报文封装在以太帧里。帧头中的源MAC地址为发送端主机1的MAC地址。此时，由于主机1不知道主机2的MAC地址，所以目的MAC地址为广播地址FF-FF-FF-FF-FF-FF。
- ARP Request报文中包含发送端MAC地址、发送端IP地址、目的端MAC地址、目的端IP地址，其中目的端MAC地址的值为0。ARP Request报文会在整个网络上传播，该网络中所有主机包括网关都会接收到此ARP Request报文。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-14-25.png" alt="参考网络模型2022-03-14-23-14-25" width="" height="">

所有的主机接收到该ARP Request报文后，都会检查它的目的端IP地址字段与自身的IP地址是否匹配。如果不匹配，则该主机将不会响应该ARP Request报文。如果匹配，则该主机会将ARP请求报文中的发送端MAC地址和发送端IP地址信息记录到自己的ARP缓存表中，然后通过ARP Reply报文进行响应。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-14-52.png" alt="参考网络模型2022-03-14-23-14-52" width="" height="">

- 主机2会向主机1回应ARP Reply报文。
- ARP Reply报文中的发送端IP地址是主机2自己的IP地址，目的端IP地址是主机1的IP地址，目的端MAC地址是主机1的MAC地址，发送端MAC地址是自己的MAC地址，同时操作类型被设置为Reply。
- ARP Reply报文通过单播传送。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-15-33.png" alt="参考网络模型2022-03-14-23-15-33" width="" height="">

主机1收到ARP Reply以后，会检查ARP报文中目的端IP地址字段与自身的IP地址是否匹配。如果匹配，ARP报文中的发送端MAC地址和发送端IP地址会被记录到主机1的ARP缓存表中。

## 2.7 物理层

- 数据到达物理层之后，物理层会根据物理介质的不同，将数字信号转换成光信号、电信号或者是电磁波信号。
- 物理层的PDU被称为比特流（Bitstream）。
- 物理层位于模型的最底层：
  - 负责比特流在介质上的传输。
  - 规范了线缆、针脚、电压、接口等物理特性规范。
  - 常见的传输介质有：双绞线、光纤、电磁波等。

> 有关介质的介绍参考[1.3.2 网络介质](md/数据通信网络基础.md#netmedia)

## 2.8 数据传输过程中的封装与解封装

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/%E5%B0%81%E8%A3%85%E4%B8%8E%E8%A7%A3%E5%B0%81%E8%A3%85.png" style="zoom:150%;" />

### 2.8.1 发送方数据封装

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-21-04.png" alt="参考网络模型2022-03-14-23-21-04" width="" height="">

网页浏览器访问网站

1. IE浏览器(应用程序)调用HTTP(应用层协议)，完成应用层数据的封装(图中DATA还应包括HTTP头部，此处省略)。
2. HTTP依靠传输层的TCP进行数据的可靠性传输，将封装好的数据传递到TCP模块。
3. TCP模块给应用层传递下来的Data添加上相应的TCP头部信息(源端口、目的端口等)。此时的PDU被称作Segment(段)。
4. 在IPv4网络中，TCP模块会将封装好的Segment传递给网络层的IPv4模块(若在IPv6环境，会交给IPv6模块进行处理)。
5. IPv4模块在收到TCP模块传递来的Segment之后，完成IPv4头部的封装，此时的PDU被称为Packet(包)。
6. 由于使用了Ethernet作为数据链路层协议，故在IPv4模块完成封装之后，会将Packet交由数据链路层的Ethernet模块(例如以太网卡)处理。
7. Ethernet模块在收到IPv4模块传递来的Packet之后，添加上相应的Ethernet头部信息和FCS帧尾，此时的PDU被称为Frame(帧)。
8. 在Ethernet模块封装完毕之后，会将数据传递到物理层。
9. 根据物理介质的不同，物理层负责将数字信号转换成电信号，光信号，电磁波(无线)信号等。
10. 转换完成的信号在网络中开始传递。

### 2.8.2 中间网络数据传输

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-21-30.png" alt="参考网络模型2022-03-14-23-21-30" width="" height="">

- 网络中的二层设备（如以太网交换机）只会解封装数据的二层头部，根据二层头部的信息进行相应的“交换”操作。
- 网络中的三层设备（如路由器）只会解封装到三层头部，并且根据三层头部的信息进行相应的“路由”操作。
- 注：“交换”和“路由”的详细细节和原则，将会在后面的课程中详细介绍。

### 2.8.3 接收方数据解封装

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-22-36.png" alt="参考网络模型2022-03-14-23-22-36" width="" height="">

经过中间网络传递之后，数据最终到达目的服务器。根据不同的协议头部的信息，数据将被一层层的解封装并做相应的处理和传递，最终交由WEB服务器上的应用程序进行处理。