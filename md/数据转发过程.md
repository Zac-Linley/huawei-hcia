> TCPIP协议簇和底层协议配合，保证了数据能够实现端到端的传输。数据传输过程是一个非常复杂的过程，例如数据在转发的过程中会进行一系列的封装和解封装。对于网络工程师来说，只有深入地理解了数据在各种不同设备上的转发过程，才能够对网络进行正确的分析和检测

## 8.1 网关Gateway :id=gateway

- 报文转发过程中，首先需要确定转发路径以及通往目的网段的接口；
- 位于不同网络内的主机要实现通讯，必须把数据包发送给网关，然后通过网关将报文转发到目的网段；
- 网关通常就是一台三层网络设备（路由器、三层交换机、防火墙），网关地址就是这些设备的接口地址。

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/数据转发过程2022-03-17-22-45-17.png" alt="数据转发过程2022-03-17-22-45-17" width="500" height="">

> 网关是指接收并处理本地网段主机发送的报文并转发到目的网段的设备。为实现此功能，网关必须知道目的网段的路由。网关设备上连接本地网段的接口地址即为该网段的网关地址。

## 8.2 数据传输过程中的封装与解封装

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/%E5%B0%81%E8%A3%85%E4%B8%8E%E8%A7%A3%E5%B0%81%E8%A3%85.png" style="zoom:150%;" />

### 8.2.1 发送方数据封装

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-21-04.png" alt="参考网络模型2022-03-14-23-21-04" width="" height="">

网页浏览器访问网站

1. IE浏览器(应用程序)调用HTTP(应用层协议)，完成应用层数据的封装(图中DATA还应包括HTTP头部，此处省略)。
2. HTTP依靠传输层的TCP进行数据的可靠性传输，将封装好的数据传递到TCP模块。
3. TCP模块给应用层传递下来的Data添加上相应的TCP头部信息(源端口、目的端口等)。此时的PDU被称作Segment(段)。
4. 在IPv4网络中，TCP模块会将封装好的Segment传递给网络层的IPv4模块(若在IPv6环境，会交给IPv6模块进行处理)。
5. IPv4模块在收到TCP模块传递来的Segment之后，完成IPv4头部的封装，此时的PDU被称为Packet(包)。
6. 由于使用了Ethernet作为数据链路层协议，故在IPv4模块完成封装之后，会将Packet交由数据链路层的Ethernet模块(例如以太网卡)处理。
7. Ethernet模块在收到IPv4模块传递来的Packet之后，添加上相应的Ethernet头部信息和FCS帧尾，此时的PDU被称为Frame(帧)。
8. 在Ethernet模块封装完毕之后，会将数据传递到物理层。
9. 根据物理介质的不同，物理层负责将数字信号转换成电信号，光信号，电磁波(无线)信号等。
10. 转换完成的信号在网络中开始传递。

### 8.2.2 中间网络数据传输

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-21-30.png" alt="参考网络模型2022-03-14-23-21-30" width="" height="">

- 网络中的二层设备（如以太网交换机）只会解封装数据的二层头部，根据二层头部的信息进行相应的“交换”操作。
- 网络中的三层设备（如路由器）只会解封装到三层头部，并且根据三层头部的信息进行相应的“路由”操作。
- 注：“交换”和“路由”的详细细节和原则，将会在后面的课程中详细介绍。

### 8.2.3 接收方数据解封装

<img src="https://linley.oss-cn-shanghai.aliyuncs.com/typora_image/参考网络模型2022-03-14-23-22-36.png" alt="参考网络模型2022-03-14-23-22-36" width="" height="">

经过中间网络传递之后，数据最终到达目的服务器。根据不同的协议头部的信息，数据将被一层层的解封装并做相应的处理和传递，最终交由WEB服务器上的应用程序进行处理。